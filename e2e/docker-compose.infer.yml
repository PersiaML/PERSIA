version: "3.3"
services:
        torch_serve:
            env_file:
                - adult_income/.test_env
            environment:
                JOB_ID: 1
                EVAL_CHECKPOINT_DIR: /workspace/eval_checkpoint/${IMAGE_TYPE}
                INFER_CHECKPOINT_DIR: /workspace/infer_checkpoint/${IMAGE_TYPE}
                HDFS_CHECKPOINT_DIR: hdfs://localhost:9000//workspace/hdfs_checkpoint/${IMAGE_TYPE}
                RESULT_FILE_PATH: /workspace/result_${IMAGE_TYPE}.json
            image: persia-${IMAGE_TYPE}-runtime:test
            command: bash -c "/workspace/launch_ts.sh"
            volumes:
                - ./adult_income:/workspace
                - /data/adult_income:/data/
            deploy:
                endpoint_mode: dnsrr
            depends_on:
                - middleware
                - emb_server

        middleware:
            env_file:
                - adult_income/.test_env
            environment:
                JOB_ID: 1
            image: persia-${IMAGE_TYPE}-runtime:test
            command: persia_launcher middleware --embedding-config /workspace/config/embedding_config.yml --global-config /workspace/config/global_config_infer.yml
            volumes:
                - ./adult_income:/workspace
            deploy:
                endpoint_mode: dnsrr
            depends_on:
                - emb_server

        emb_server:
            env_file:
                - adult_income/.test_env
            environment:
                JOB_ID: 1
            image: persia-${IMAGE_TYPE}-runtime:test
            command: persia_launcher server --embedding-config /workspace/config/embedding_config.yml --global-config /workspace/config/global_config_infer.yml
            volumes:
                - ./adult_income:/workspace
            deploy:
                endpoint_mode: dnsrr